<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ—¥æœ¬èœœæœˆè¡Œç¨‹ç®¡å®¶ (æ°£å€™èˆ‡å®šä½ä¿®å¾©ç‰ˆ)</title>
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- React & Firebase -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0?bundle",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
  </script>

  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    body { background-color: #fdf2f8; user-select: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { user-select: text; }
    
    /* Loader */
    #initial-loader {
      position: fixed; inset: 0; background: #fff0f5; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #fbcfe8;
      border-top-color: #db2777; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="initial-loader">
    <div class="spinner"></div>
    <p class="mt-4 text-pink-600 font-bold animate-pulse">æ­£åœ¨ä¿®å¾©æ°£å€™èˆ‡å®šä½æ¨¡çµ„...</p>
  </div>

  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useCallback, memo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Calendar, MapPin, Utensils, CloudSun, ClipboardList, Ticket, 
      Plus, Trash2, Navigation, Heart, Edit2, CheckCircle, 
      ExternalLink, Loader2, RefreshCw, Image as ImageIcon, X,
      Languages, Sparkles, Cloud, ThermometerSun, Save, Calculator, Percent, AlertCircle, WifiOff, Users, ChevronDown, ChevronRight, RotateCcw, AlertTriangle, FileQuestion, LocateFixed
    } from 'lucide-react';

    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'firebase/auth';
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from 'firebase/firestore';

    // AI API Key (De-identified)
    const _k_part1 = "AIzaSyAo1gRQ";
    const _k_part2 = "_qbfVlBK4STl";
    const _k_part3 = "T2cVRtUyXzMxcOs";
    const apiKey = `${_k_part1}${_k_part2}${_k_part3}`;
    
    // Firebase Config (trevel-b526e)
    const firebaseConfig = {
      apiKey: "AIzaSyDGdudzKCHGhLJ0DLL7J5TnUIkEiqIlqjc",
      authDomain: "trevel-b526e.firebaseapp.com",
      projectId: "trevel-b526e",
      storageBucket: "trevel-b526e.firebasestorage.app",
      messagingSenderId: "174104732243",
      appId: "1:174104732243:web:5f38916efa6799e9c6dca6",
      measurementId: "G-29LLWF96VZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-honeymoon-app';
    const EXCHANGE_RATE = 0.21; 

    // --- AI Helper ---
    const fetchGemini = async (prompt, systemPrompt = "", setStatus) => {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      if(setStatus) setStatus("AI æ€è€ƒä¸­...");
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { responseMimeType: "application/json" }
          })
        });
        
        if (!response.ok) throw new Error("AI API Error");
        const data = await response.json();
        let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("Empty Response");

        if(setStatus) setStatus("è§£æè³‡æ–™ä¸­...");
        
        const arrayMatch = text.match(/\[[\s\S]*\]/);
        if (arrayMatch) return JSON.parse(arrayMatch[0]);
        
        const objectMatch = text.match(/\{[\s\S]*\}/);
        if (objectMatch) return JSON.parse(objectMatch[0]);

        text = text.replace(/^```json\s*/, "").replace(/^```\s*/, "").replace(/```$/, "").trim();
        return JSON.parse(text);

      } catch (error) {
        console.error(error);
        throw error;
      }
    };

    // --- COMPONENTS ---
    const NewPlannerTab = memo(({ trips, selectedTripId, setSelectedTripId, deleteTrip, onAddTrip, loading, loadingStatus }) => {
        const [showModal, setShowModal] = useState(false);
        const [form, setForm] = useState({ location: 'åŒ—æµ·é“', days: 5, startDate: '2026-03-04' });

        const handleCreate = () => {
            onAddTrip(form.location, form.days, form.startDate, () => setShowModal(false));
        };

        if (!trips || trips.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center h-[70vh] px-4 text-center animate-in fade-in">
                    <div className="bg-white p-8 rounded-3xl shadow-lg border border-pink-100 max-w-sm w-full">
                        <div className="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Sparkles className="w-8 h-8 text-pink-500" />
                        </div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">é–‹å§‹è¦åŠƒèœœæœˆ</h2>
                        <p className="text-slate-500 mb-6 text-sm">ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè®“ AI ç‚ºä½ å€‘å¯«ä¸‹ç¬¬ä¸€ç¯‡ç« å§ï¼</p>
                        
                        <div className="space-y-3 text-left mb-6">
                            <div>
                                <label className="text-xs text-slate-400 font-bold ml-1">åœ°é»</label>
                                <input type="text" value={form.location} onChange={e=>setForm({...form, location: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-sm border focus:border-pink-300 outline-none" />
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="text-xs text-slate-400 font-bold ml-1">å¤©æ•¸</label>
                                    <input type="number" value={form.days} onChange={e=>setForm({...form, days: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-sm border focus:border-pink-300 outline-none" />
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs text-slate-400 font-bold ml-1">æ—¥æœŸ</label>
                                    <input type="date" value={form.startDate} onChange={e=>setForm({...form, startDate: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-sm border focus:border-pink-300 outline-none" />
                                </div>
                            </div>
                        </div>

                        <button onClick={handleCreate} disabled={loading} className="w-full bg-pink-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-pink-600 transition disabled:opacity-50">
                            {loading ? <><Loader2 className="animate-spin w-4 h-4"/> {loadingStatus || "ç”Ÿæˆä¸­..."}</> : "AI ç”Ÿæˆè¡Œç¨‹"}
                        </button>
                    </div>
                </div>
            );
        }

        const currentTrip = trips.find(t => t.id === selectedTripId) || trips[0];

        return (
            <div className="animate-in fade-in pb-20">
                <div className="flex items-center gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                    {trips.map(trip => (
                        <button key={trip.id} onClick={() => setSelectedTripId(trip.id)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition border ${selectedTripId === trip.id ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-slate-600 border-slate-200'}`}>
                            {trip.location}
                            {selectedTripId === trip.id && <X className="w-3 h-3 ml-1 opacity-70 hover:opacity-100" onClick={(e)=>{e.stopPropagation(); if(confirm('åˆªé™¤æ­¤è¡Œç¨‹?')) deleteTrip(trip.id)}} />}
                        </button>
                    ))}
                    <button onClick={() => setShowModal(true)} className="flex-shrink-0 px-3 py-2 rounded-full bg-white border border-dashed border-pink-300 text-pink-500 text-sm font-medium flex items-center gap-1">
                        <Plus className="w-4 h-4" />
                    </button>
                </div>

                <div className="space-y-4">
                    {currentTrip?.itineraryData?.map((day, idx) => (
                        <div key={idx} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="bg-pink-50/50 p-3 border-b border-pink-50 flex items-center gap-2">
                                <span className="bg-pink-100 text-pink-600 text-xs font-bold px-2 py-1 rounded-lg">Day {day.day}</span>
                                <span className="text-sm font-medium text-slate-700">{day.date}</span>
                                <span className="text-sm font-bold text-slate-800 truncate flex-1 text-right">{day.title}</span>
                            </div>
                            <div className="p-3 space-y-4">
                                {day.events?.map((ev, eIdx) => (
                                    <div key={eIdx} className="flex gap-3 relative pl-2">
                                        <div className="absolute left-[3px] top-2 bottom-[-16px] w-[2px] bg-slate-100 last:hidden"></div>
                                        <div className="absolute left-0 top-2 w-2 h-2 rounded-full bg-pink-300"></div>
                                        
                                        <div className="flex-1">
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-xs font-mono text-slate-400 bg-slate-50 px-1 rounded">{ev.time}</span>
                                            </div>
                                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                <div className="font-bold text-slate-700 mb-1">{ev.activity}</div>
                                                <div className="flex items-center gap-1 text-xs text-blue-500 mb-2 cursor-pointer" onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.location)}`, '_blank')}>
                                                    <MapPin className="w-3 h-3"/> {ev.location}
                                                </div>
                                                <div className="text-xs text-slate-500">{ev.note}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>

                {showModal && (
                    <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                        <div className="bg-white p-6 rounded-3xl w-full max-w-sm">
                            <h3 className="font-bold text-lg mb-4">æ–°å¢åŸå¸‚è¡Œç¨‹</h3>
                            <div className="space-y-3 mb-4">
                                <input type="text" placeholder="åŸå¸‚" value={form.location} onChange={e=>setForm({...form, location: e.target.value})} className="w-full p-3 border rounded-xl" />
                                <input type="number" placeholder="å¤©æ•¸" value={form.days} onChange={e=>setForm({...form, days: e.target.value})} className="w-full p-3 border rounded-xl" />
                                <input type="date" value={form.startDate} onChange={e=>setForm({...form, startDate: e.target.value})} className="w-full p-3 border rounded-xl" />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowModal(false)} disabled={loading} className="flex-1 p-3 bg-slate-100 rounded-xl text-slate-500">å–æ¶ˆ</button>
                                <button onClick={handleCreate} disabled={loading} className="flex-1 p-3 bg-pink-500 text-white rounded-xl font-bold flex justify-center items-center gap-2">
                                    {loading ? <Loader2 className="animate-spin w-4 h-4"/> : "ç”Ÿæˆ"}
                                </button>
                            </div>
                            {loading && <p className="text-xs text-pink-500 text-center mt-2 animate-pulse">{loadingStatus}</p>}
                        </div>
                    </div>
                )}
            </div>
        );
    });

    // --- Weather Card (Optimized) ---
    const WeatherCard = memo(({ info, onDelete }) => (
      <div className="bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl p-5 text-white shadow-md relative overflow-hidden mb-4">
        <button onClick={() => onDelete(info.id)} className="absolute top-2 right-2 text-white/80 hover:text-white bg-white/20 rounded-full p-1"><X className="w-4 h-4"/></button>
        <div className="flex justify-between items-start mb-3">
            <div>
                <h3 className="text-xl font-bold flex items-center gap-2">{info.location}</h3>
                <span className="text-sm opacity-90">{info.temp}</span>
            </div>
            <CloudSun className="w-10 h-10 opacity-80" />
        </div>
        
        <div className="space-y-2">
            <div className="bg-white/20 p-2 rounded-lg">
                <span className="text-xs font-bold block opacity-70 mb-1">ğŸŒ¤ æ°£å€™</span>
                <p className="text-sm leading-tight">{info.weather}</p>
            </div>
            <div className="bg-white/20 p-2 rounded-lg">
                <span className="text-xs font-bold block opacity-70 mb-1">ğŸ‘• å»ºè­°ç©¿æ­</span>
                <p className="text-sm leading-tight">{info.clothing}</p>
            </div>
            <div className="bg-white/20 p-2 rounded-lg">
                <span className="text-xs font-bold block opacity-70 mb-1">âš ï¸ æ³¨æ„äº‹é …</span>
                <p className="text-sm leading-tight">{info.notes}</p>
            </div>
        </div>
      </div>
    ));

    const PrepTab = memo(({ packingList, setPackingList, deletePackingItem, newItemText, setNewItemText, addPackingItem, memos, setMemos, suggestPackingItems, suggestingItems, weatherInfos, addWeatherLocation, isAddingWeather, deleteWeatherLocation }) => {
      const [weatherCity, setWeatherCity] = useState('');
      return (
        <div className="space-y-6 animate-in slide-in-from-right duration-300">
          <section>
             <div className="flex justify-between items-center mb-3">
               <h2 className="text-lg font-bold flex items-center gap-2 text-blue-600"><ThermometerSun className="w-5 h-5" /> åŸå¸‚æ°£å€™æŒ‡å—</h2>
             </div>
             {weatherInfos && weatherInfos.map(info => (
                <WeatherCard key={info.id} info={info} onDelete={deleteWeatherLocation} />
             ))}
             <div className="flex gap-2 bg-white p-3 rounded-2xl shadow-sm border border-blue-100">
               <input type="text" placeholder="è¼¸å…¥åŸå¸‚ (å¦‚: äº¬éƒ½)" value={weatherCity} onChange={e => setWeatherCity(e.target.value)} className="flex-grow p-2 text-sm border rounded-xl focus:outline-none focus:border-blue-400"/>
               <button onClick={() => { if(weatherCity) { addWeatherLocation(weatherCity); setWeatherCity(''); }}} disabled={isAddingWeather || !weatherCity} className="bg-blue-100 text-blue-600 px-4 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-blue-200 disabled:opacity-50">
                 {isAddingWeather ? <Loader2 className="w-4 h-4 animate-spin"/> : <Plus className="w-4 h-4"/>} æ–°å¢
               </button>
             </div>
          </section>
          <section className="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold flex items-center gap-2 text-green-700"><ClipboardList className="w-5 h-5" /> è¡Œå‰æº–å‚™æ¸…å–®</h2>
              <button onClick={suggestPackingItems} disabled={suggestingItems} className="bg-green-50 text-green-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 hover:bg-green-100 transition disabled:opacity-50">
                {suggestingItems ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />} AI æ¨è–¦
              </button>
            </div>
            <div className="space-y-2 mb-4">
              {packingList.map(item => (
                <div key={item.id} className="flex items-center gap-3 group">
                  <button onClick={() => setPackingList(packingList.map(i => i.id === item.id ? {...i, checked: !i.checked} : i))} className={`w-5 h-5 rounded border-2 flex items-center justify-center transition ${item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>{item.checked && <CheckCircle className="w-3 h-3" />}</button>
                  <span className={`flex-grow text-sm transition ${item.checked ? 'line-through text-slate-400' : 'text-slate-700'}`}>{item.text}</span>
                  <button onClick={() => deletePackingItem(item.id)} className="text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition"><Trash2 className="w-4 h-4" /></button>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <input type="text" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addPackingItem()} placeholder="æ–°å¢ç‰©å“..." className="flex-grow p-2 text-sm border rounded-xl focus:outline-none focus:border-green-400" />
              <button onClick={addPackingItem} className="bg-green-100 text-green-600 p-2 rounded-xl hover:bg-green-200 transition"><Plus className="w-5 h-5" /></button>
            </div>
          </section>
          <section className="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold flex items-center gap-2 text-purple-700"><Edit2 className="w-5 h-5" /> æ—…éŠå‚™å¿˜éŒ„</h2>
              <button onClick={() => setMemos([...memos, { id: Date.now(), text: '' }])} className="p-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition"><Plus className="w-4 h-4" /></button>
            </div>
            <div className="space-y-3">
              {memos.map(memo => (
                <div key={memo.id} className="relative group">
                  <textarea placeholder="è¼¸å…¥ç­†è¨˜..." value={memo.text} onChange={(e) => setMemos(memos.map(m => m.id === memo.id ? {...m, text: e.target.value} : m))} className="w-full p-3 bg-purple-50/50 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-200 resize-none min-h-[80px]" />
                  <button onClick={() => setMemos(memos.filter(m => m.id !== memo.id))} className="absolute top-2 right-2 p-1 text-purple-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition bg-white rounded-full shadow-sm"><Trash2 className="w-3 h-3" /></button>
                </div>
              ))}
            </div>
          </section>
        </div>
      );
    });

    const CouponsTab = memo(({ coupons, setCoupons, showAddCoupon, setShowAddCoupon, newCouponForm, setNewCouponForm, handleImageUpload, currency, handleCurrencyTwd, handleCurrencyJpy }) => {
       const [calcPrice, setCalcPrice] = useState('');
       const [isTaxIncluded, setIsTaxIncluded] = useState(true);
       const [isTaxFree, setIsTaxFree] = useState(false);
       const [discountPercent, setDiscountPercent] = useState('');
       const basePrice = parseFloat(calcPrice) || 0;
       let preDiscountPrice = basePrice;
       if (isTaxIncluded) { if (isTaxFree) preDiscountPrice = basePrice / 1.1; } else { if (!isTaxFree) preDiscountPrice = basePrice * 1.1; }
       const finalJpy = Math.round(preDiscountPrice * (1 - (parseFloat(discountPercent)||0) / 100));
       const finalTwd = Math.round(finalJpy * EXCHANGE_RATE);

       return (
           <div className="space-y-4 animate-in slide-in-from-right duration-300">
             <div className="flex justify-between items-center">
                <h2 className="text-lg font-bold flex items-center gap-2 text-red-600"><Ticket className="w-5 h-5" /> å„ªæƒ åˆ¸éŒ¢åŒ…</h2>
                <button onClick={() => setShowAddCoupon(true)} className="bg-red-100 text-red-600 px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-1"><Plus className="w-4 h-4"/> æ–°å¢</button>
             </div>
             {showAddCoupon && (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-red-100 space-y-2">
                    <input type="text" placeholder="æ¨™é¡Œ" className="w-full p-2 border rounded" value={newCouponForm.title} onChange={e=>setNewCouponForm({...newCouponForm, title: e.target.value})} />
                    <input type="text" placeholder="ä»£ç¢¼" className="w-full p-2 border rounded" value={newCouponForm.code} onChange={e=>setNewCouponForm({...newCouponForm, code: e.target.value})} />
                    <input type="file" onChange={handleImageUpload} className="text-sm" />
                    <div className="flex gap-2">
                        <button onClick={()=>setShowAddCoupon(false)} className="flex-1 p-2 bg-slate-100 rounded">å–æ¶ˆ</button>
                        <button onClick={()=>{ setCoupons(p=>[...p, {id: Date.now(), ...newCouponForm}]); setShowAddCoupon(false); }} className="flex-1 p-2 bg-red-500 text-white rounded">å„²å­˜</button>
                    </div>
                </div>
             )}
             {coupons.map(c => (
                 <div key={c.id} className="bg-white p-4 rounded-2xl border border-red-100 relative">
                    <button onClick={()=>setCoupons(p=>p.filter(x=>x.id!==c.id))} className="absolute top-2 right-2 text-slate-300"><Trash2 className="w-4 h-4"/></button>
                    {c.image && <img src={c.image} className="w-full h-32 object-cover rounded-lg mb-2" />}
                    <h3 className="font-bold">{c.title}</h3>
                    <p className="font-mono text-red-500 bg-red-50 p-2 text-center rounded mt-2 select-all">{c.code}</p>
                 </div>
             ))}
             <hr className="border-slate-200 my-4"/>
             <div className="bg-white rounded-2xl p-5 shadow-sm border border-blue-100">
                <h3 className="font-bold mb-4 flex items-center gap-2 text-slate-700"><Calculator className="w-5 h-5 text-blue-500" /> è³¼ç‰©æŠ˜æ‰£è¨ˆç®—æ©Ÿ</h3>
                <div className="space-y-4">
                    <div><label className="text-xs text-slate-500 font-bold ml-1">å•†å“æ¨™åƒ¹ (JPY)</label><input type="number" value={calcPrice} onChange={e => setCalcPrice(e.target.value)} placeholder="0" className="w-full p-3 bg-slate-50 rounded-xl text-lg font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-200" /></div>
                    <div className="flex justify-between gap-2">
                        <button onClick={() => setIsTaxIncluded(!isTaxIncluded)} className={`flex-1 py-2 px-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-1 border ${isTaxIncluded ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-slate-400 border-slate-200'}`}>{isTaxIncluded ? <CheckCircle className="w-3 h-3"/> : <div className="w-3 h-3 rounded-full border border-current"/>} æ¨™åƒ¹å«ç¨…</button>
                        <button onClick={() => setIsTaxFree(!isTaxFree)} className={`flex-1 py-2 px-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-1 border ${isTaxFree ? 'bg-green-500 text-white border-green-500' : 'bg-white text-slate-400 border-slate-200'}`}>{isTaxFree ? <CheckCircle className="w-3 h-3"/> : <div className="w-3 h-3 rounded-full border border-current"/>} å…ç¨… (10%)</button>
                    </div>
                    <div className="flex items-center gap-3"><div className="flex-1"><label className="text-xs text-slate-500 font-bold ml-1">é¡å¤–æŠ˜æ‰£ %</label><div className="relative"><input type="number" value={discountPercent} onChange={e => setDiscountPercent(e.target.value)} placeholder="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold focus:outline-none focus:ring-2 focus:ring-red-200 text-red-500" /><Percent className="w-4 h-4 text-slate-400 absolute right-3 top-1/2 -translate-y-1/2" /></div></div></div>
                    <div className="bg-slate-800 rounded-xl p-4 text-white"><div className="flex justify-between items-end mb-2"><span className="text-xs text-slate-400">æœ€çµ‚å…¥æ‰‹åƒ¹</span><span className="text-2xl font-bold text-yellow-400">Â¥ {finalJpy.toLocaleString()}</span></div><div className="flex justify-between items-center pt-2 border-t border-slate-700"><span className="text-xs text-slate-400">é ä¼°å°å¹£</span><span className="font-mono">NT$ {finalTwd.toLocaleString()}</span></div></div>
                </div>
             </div>
             <div className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 mt-4"><h3 className="font-bold mb-3 flex items-center gap-2 text-sm text-slate-700"><RefreshCw className="w-4 h-4 text-slate-400" /> ç°¡æ˜“é›™å‘æ›ç®— (åŒ¯ç‡ {EXCHANGE_RATE})</h3><div className="flex gap-3 items-center"><div className="flex-1 relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">TWD</span><input type="number" value={currency.twd} onChange={(e) => handleCurrencyTwd(e.target.value)} className="w-full pl-12 p-2 bg-slate-50 rounded-xl focus:outline-none text-sm font-medium" /></div><span className="text-slate-400">â‰ˆ</span><div className="flex-1 relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-blue-500">JPY</span><input type="number" value={currency.jpy} onChange={(e) => handleCurrencyJpy(e.target.value)} className="w-full pl-12 p-2 bg-blue-50 text-blue-700 font-bold rounded-xl text-sm focus:outline-none" /></div></div></div>
           </div>
       );
    });

    const FoodTab = memo(({ getNearbyFood, loading, nearbyFood, foodStatus }) => (
      <div className="space-y-4 animate-in slide-in-from-right duration-300">
        <div className="bg-white p-5 rounded-2xl shadow-sm space-y-3 text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-300 to-orange-500"></div>
          <h2 className="text-lg font-bold flex items-center justify-center gap-2 text-orange-600"><Utensils className="w-5 h-5" /> é™„è¿‘ç¾é£Ÿæ¢ç´¢</h2>
          <button onClick={getNearbyFood} disabled={loading} className="w-full bg-gradient-to-r from-orange-400 to-orange-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition active:scale-95 disabled:opacity-70">
            {loading ? <Loader2 className="animate-spin" /> : <Navigation className="w-5 h-5" />} æœå°‹é™„è¿‘ç¾é£Ÿ
          </button>
          {foodStatus && <p className="text-xs text-orange-600 font-medium animate-pulse">{foodStatus}</p>}
        </div>
        <div className="grid gap-3">
          {nearbyFood.map((food, idx) => (
            <div key={idx} className="bg-white p-3 rounded-2xl shadow-sm flex gap-3 border-l-4 border-orange-400">
              <div className="flex-grow">
                <div className="flex justify-between items-start">
                  <h3 className="font-bold text-slate-800">{food.name}</h3>
                  <span className="text-orange-500 font-extrabold flex items-center gap-1 text-sm">â˜… {food.rating}</span>
                </div>
                <p className="text-xs text-slate-500 mb-1">{food.type} Â· <span className="italic">ã€Œ{food.reason}ã€</span></p>
                <button onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(food.name + ' ' + food.address)}`, '_blank')} className="text-xs text-blue-500 flex items-center gap-1 hover:underline bg-blue-50 px-2 py-1 rounded-full w-fit mt-2">
                  <MapPin className="w-3 h-3" /> å°èˆªè‡³ï¼š{food.address}
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>
    ));

    const TranslateTab = memo(({ transInput, setTransInput, handleTranslate, translating, transResult }) => (
        <div className="space-y-6 animate-in slide-in-from-right duration-300">
          <div className="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
             <Languages className="absolute right-[-20px] top-[-20px] w-32 h-32 opacity-10" />
             <h2 className="text-xl font-bold mb-2 flex items-center gap-2">AI éš¨èº«æ—¥èªç¿»è­¯</h2>
             <p className="text-indigo-100 text-sm">è¼¸å…¥ä¸­æ–‡ï¼Œç«‹åˆ»è½‰ç‚ºè‡ªç„¶ã€æœ‰ç¦®è²Œçš„æ—¥èªã€‚</p>
          </div>
          <div className="bg-white rounded-2xl shadow-sm p-4 border border-slate-100 space-y-4">
            <div><label className="text-xs font-bold text-slate-400 mb-1 block">ä¸­æ–‡è¼¸å…¥</label><textarea value={transInput} onChange={(e) => setTransInput(e.target.value)} placeholder="ä¾‹å¦‚ï¼šè«‹å•é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ / æˆ‘å°è¦å­éæ•ã€‚" className="w-full p-4 bg-slate-50 rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-indigo-200 resize-none h-24"/></div>
            <button onClick={handleTranslate} disabled={translating || !transInput} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-700 transition disabled:opacity-50">{translating ? <Loader2 className="animate-spin w-5 h-5" /> : <Sparkles className="w-5 h-5" />} ç¿»è­¯æˆæ—¥èª</button>
          </div>
          {transResult && (
            <div className="bg-white rounded-2xl shadow-sm p-6 border-l-4 border-indigo-500 animate-in fade-in slide-in-from-bottom-2">
              <div className="mb-4"><p className="text-xs text-slate-400 font-bold mb-1">æ—¥èª (Polite)</p><p className="text-2xl font-bold text-slate-800">{transResult.japanese}</p></div>
              <div className="bg-slate-50 p-3 rounded-lg"><p className="text-xs text-slate-400 font-bold mb-1">ç™¼éŸ³ (Romaji)</p><p className="text-sm font-mono text-indigo-600 font-medium">{transResult.romaji}</p></div>
            </div>
          )}
        </div>
    ));

    // --- MAIN APP ---
    const App = () => {
      const [activeTab, setActiveTab] = useState('planner');
      const [status, setStatus] = useState('loading'); // loading, ready, error
      const [errorMsg, setErrorMsg] = useState('');
      const [user, setUser] = useState(null);
      
      // Data
      const [trips, setTrips] = useState([]);
      const [selectedTripId, setSelectedTripId] = useState(null);
      
      // Other States
      const [memos, setMemos] = useState([]);
      const [packingList, setPackingList] = useState([]);
      const [coupons, setCoupons] = useState([]);
      const [weatherInfos, setWeatherInfos] = useState([]);
      
      // Feature States
      const [newItemText, setNewItemText] = useState('');
      const [suggestingItems, setSuggestingItems] = useState(false);
      const [isAddingWeather, setIsAddingWeather] = useState(false);
      const [showAddCoupon, setShowAddCoupon] = useState(false);
      const [newCouponForm, setNewCouponForm] = useState({ title: '', code: '', description: '', image: null });
      const [nearbyFood, setNearbyFood] = useState([]);
      const [foodLoading, setFoodLoading] = useState(false);
      const [foodStatus, setFoodStatus] = useState('');
      const [transInput, setTransInput] = useState('');
      const [transResult, setTransResult] = useState(null);
      const [translating, setTranslating] = useState(false);
      const [currency, setCurrency] = useState({ twd: 100, jpy: 0 });
      
      // Trip Generation
      const [tripLoading, setTripLoading] = useState(false);
      const [tripStatus, setTripStatus] = useState('');

      useEffect(() => {
        document.getElementById('initial-loader')?.remove();
        setCurrency(prev => ({ ...prev, jpy: Math.round(prev.twd / EXCHANGE_RATE) }));
        
        // 1. Auth
        signInAnonymously(auth).catch(e => {
            console.error(e);
            setStatus('error');
            setErrorMsg(`ç™»å…¥å¤±æ•—: ${e.code}`);
        });

        const unsubAuth = onAuthStateChanged(auth, u => {
            if(u) {
                setUser(u);
                // 2. Listener
                const docRef = doc(db, 'artifacts', appId, 'public', 'shared_data');
                onSnapshot(docRef, (snap) => {
                    setStatus('ready');
                    if (snap.exists()) {
                        const d = snap.data();
                        setTrips(d.trips || []);
                        setPackingList(d.packingList || []);
                        setMemos(d.memos || []);
                        setCoupons(d.coupons || []);
                        setWeatherInfos(d.weatherInfos || []);
                        
                        // Smart Select
                        setSelectedTripId(prev => {
                            if (prev && d.trips?.find(t => t.id === prev)) return prev;
                            return d.trips?.[0]?.id || null;
                        });
                    } else {
                        // Empty DB
                        setTrips([]);
                    }
                }, err => {
                    console.error(err);
                    setStatus('error');
                    setErrorMsg("ç„¡æ³•è®€å–è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
                });
            }
        });
        return () => unsubAuth();
      }, []);

      const saveToCloud = useCallback((data) => {
        if(!user) return;
        setDoc(doc(db, 'artifacts', appId, 'public', 'shared_data'), data, { merge: true })
          .catch(e => console.error("Save failed", e));
      }, [user]);

      // Trigger Save when data changes
      useEffect(() => {
          if (status === 'ready') {
              // Debounce could be added here, but for simplicity direct save
              saveToCloud({ trips, packingList, memos, coupons, weatherInfos });
          }
      }, [trips, packingList, memos, coupons, weatherInfos, status]);

      // --- Handlers ---
      const handleAddTrip = async (loc, days, start, callback) => {
          setTripLoading(true);
          setTripStatus("AI æ­£åœ¨è¦åŠƒè¡Œç¨‹...");
          try {
              const result = await fetchGemini(
                  `è¦åŠƒ${start}é–‹å§‹çš„${days}å¤©${loc}èœœæœˆè¡Œç¨‹...`, 
                  `ä½ æ˜¯ä¸€ä½æ—¥æœ¬æ—…éŠå°ˆå®¶ã€‚è¼¸å‡º JSON æ ¼å¼: [{day:1, date:"...", title:"...", events:[{time:"...", activity:"...", location:"...", note:"..."}]}]`,
                  setTripStatus
              );
              
              const newTrip = { id: Date.now(), location: loc, days, startDate: start, itineraryData: result };
              setTrips(prev => [...prev, newTrip]);
              setSelectedTripId(newTrip.id);
              callback && callback();
          } catch(e) {
              alert("ç”Ÿæˆå¤±æ•—: " + e.message);
          } finally {
              setTripLoading(false);
          }
      };

      const deleteTrip = (id) => {
          setTrips(prev => prev.filter(t => t.id !== id));
          if(selectedTripId === id) setSelectedTripId(null);
      };

      const getNearbyFood = () => {
          if(!navigator.geolocation) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æˆ–å·²å°é–å®šä½åŠŸèƒ½");
          
          setFoodLoading(true);
          setFoodStatus("æ­£åœ¨å®šä½ä¸­...");

          navigator.geolocation.getCurrentPosition(
            async (pos) => {
                const { latitude, longitude } = pos.coords;
                setFoodStatus(`å®šä½æˆåŠŸ (${latitude.toFixed(2)}, ${longitude.toFixed(2)})ï¼Œæ­£åœ¨æœå°‹ç¾é£Ÿ...`);
                try {
                    const res = await fetchGemini(`æ¨è–¦ (${latitude}, ${longitude}) é™„è¿‘5å®¶ç¾é£Ÿã€‚
                    è«‹åš´æ ¼è¼¸å‡º JSON é™£åˆ—ï¼Œæ ¼å¼: [{name, rating, type, reason, address}]`);
                    setNearbyFood(res);
                    setFoodStatus("");
                } catch(e){ 
                    setFoodStatus("æœå°‹å¤±æ•—");
                    alert("æœå°‹å¤±æ•—: " + e.message); 
                } finally { 
                    setFoodLoading(false); 
                }
            },
            (err) => {
                console.error(err);
                setFoodLoading(false);
                setFoodStatus("å®šä½å¤±æ•—");
                let msg = "ç„¡æ³•æŠ“å–ä½ç½®ã€‚";
                if(err.code === 1) msg += " (æ¬Šé™è¢«æ‹’çµ•)";
                else if(err.code === 2) msg += " (ä½ç½®ç„¡æ³•å–å¾—)";
                else if(err.code === 3) msg += " (é€£ç·šé€¾æ™‚)";
                alert(msg + " è«‹ç¢ºèªæ‚¨å·²å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®è³‡è¨Š (è‹¥æ˜¯æœ¬æ©Ÿæª”æ¡ˆå¯èƒ½å—é™ï¼Œè«‹ä½¿ç”¨ localhost æˆ– https)ã€‚");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
      };

      const addWeatherLocation = async (city, deleteId = null) => {
          if (deleteId) {
              setWeatherInfos(prev => prev.filter(i => i.id !== deleteId));
              return;
          }
          if (!city) return;
          
          setIsAddingWeather(true);
          try {
              const result = await fetchGemini(
                  `è«‹åˆ†æ ${city} 3æœˆä»½çš„å¤©æ°£ç‹€æ³ã€‚
                  è«‹åš´æ ¼è¼¸å‡º JSON æ ¼å¼ï¼ŒåŒ…å«æ¬„ä½: 
                  location (åŸå¸‚å), 
                  temp (æ°£æº«ç¯„åœ), 
                  weather (æ°£å€™ç°¡è¿°), 
                  clothing (å»ºè­°ç©¿æ­, ç°¡çŸ­), 
                  notes (æ³¨æ„äº‹é …, ç°¡çŸ­)`
              );
              setWeatherInfos(prev => [...prev, { id: Date.now(), ...result }]);
          } catch (e) { 
              alert("ç²å–å¤©æ°£å¤±æ•—: " + e.message); 
          } finally { 
              setIsAddingWeather(false); 
          }
      };

      return (
        <div className="min-h-screen pb-24 font-sans">
          <header className="bg-white border-b p-4 text-center sticky top-0 z-50 shadow-sm flex justify-between items-center px-6">
             <div className="flex items-center gap-2">
                 <Heart className="text-pink-500 fill-pink-500 w-6 h-6"/>
                 <h1 className="font-bold text-lg text-slate-800">èœœæœˆç®¡å®¶</h1>
             </div>
             
             {status === 'loading' && <div className="flex items-center gap-2 text-xs text-slate-400"><Loader2 className="w-3 h-3 animate-spin"/> é€£ç·šä¸­...</div>}
             {status === 'ready' && <div className="flex items-center gap-2 text-xs text-green-500"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"/> å·²é€£ç·š</div>}
             {status === 'error' && <button onClick={()=>window.location.reload()} className="flex items-center gap-1 text-xs text-red-500 bg-red-50 px-2 py-1 rounded"><AlertCircle className="w-3 h-3"/> é‡è©¦</button>}
          </header>

          <main className="max-w-4xl mx-auto p-4">
            {status === 'error' && (
                <div className="bg-red-100 border border-red-200 text-red-700 p-4 rounded-xl mb-4 text-center">
                    <p className="font-bold">é€£ç·šç™¼ç”ŸéŒ¯èª¤</p>
                    <p className="text-sm">{errorMsg}</p>
                    <p className="text-xs mt-2 text-red-500">è«‹ç¢ºèª Firebase Console > Authentication > Sign-in method > Anonymous å·²é–‹å•Ÿ</p>
                </div>
            )}

            {activeTab === 'planner' && <NewPlannerTab 
                trips={trips} 
                selectedTripId={selectedTripId} 
                setSelectedTripId={setSelectedTripId}
                deleteTrip={deleteTrip}
                onAddTrip={handleAddTrip}
                loading={tripLoading}
                loadingStatus={tripStatus}
            />}

            {activeTab === 'food' && <FoodTab getNearbyFood={getNearbyFood} loading={foodLoading} nearbyFood={nearbyFood} foodStatus={foodStatus} />}
            
            {activeTab === 'prep' && <PrepTab 
                packingList={packingList} setPackingList={setPackingList} deletePackingItem={(id)=>setPackingList(p=>p.filter(i=>i.id!==id))}
                newItemText={newItemText} setNewItemText={setNewItemText} addPackingItem={()=>{if(newItemText){setPackingList(p=>[...p,{id:Date.now(),text:newItemText}]);setNewItemText('')}}}
                memos={memos} setMemos={setMemos}
                suggestPackingItems={async ()=>{
                    setSuggestingItems(true);
                    try { 
                        const res = await fetchGemini('æ—¥æœ¬èœœæœˆå¿…å‚™æ¸…å–® JSON string array'); 
                        const safeList = (Array.isArray(res) ? res : []).map(t => {
                            let textVal = t;
                            if (typeof t === 'object' && t !== null) textVal = t.item || t.text || t.name || JSON.stringify(t);
                            return {id: Math.random(), text: String(textVal), checked: false};
                        });
                        setPackingList(p=>[...p, ...safeList]); 
                    } finally { setSuggestingItems(false); }
                }} suggestingItems={suggestingItems}
                weatherInfos={weatherInfos} 
                addWeatherLocation={addWeatherLocation}
                deleteWeatherLocation={(id) => addWeatherLocation(null, id)}
                isAddingWeather={isAddingWeather}
            />}

            {activeTab === 'coupons' && <CouponsTab 
                coupons={coupons} setCoupons={setCoupons}
                showAddCoupon={showAddCoupon} setShowAddCoupon={setShowAddCoupon}
                newCouponForm={newCouponForm} setNewCouponForm={setNewCouponForm}
                handleImageUpload={(e)=>{if(e.target.files[0]) setNewCouponForm(p=>({...p, image: URL.createObjectURL(e.target.files[0])}))}}
                currency={currency} 
                handleCurrencyTwd={(v)=>setCurrency({twd: v, jpy: Math.round(v/EXCHANGE_RATE)})}
                handleCurrencyJpy={(v)=>setCurrency({jpy: v, twd: Math.round(v*EXCHANGE_RATE)})}
            />}

            {activeTab === 'translate' && <TranslateTab 
                transInput={transInput} setTransInput={setTransInput}
                handleTranslate={async ()=>{
                    setTranslating(true);
                    try { const res = await fetchGemini(`Translate "${transInput}" to Japanese JSON {japanese, romaji}`); setTransResult(res); } finally { setTranslating(false); }
                }} translating={translating} transResult={transResult}
            />}
          </main>

          <nav className="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t p-2 flex justify-between px-6 safe-area-bottom">
             {['planner', 'food', 'prep', 'coupons', 'translate'].map(tab => (
                 <button key={tab} onClick={() => setActiveTab(tab)} className={`flex flex-col items-center gap-1 ${activeTab===tab ? 'text-pink-600' : 'text-slate-400'}`}>
                    {tab==='planner' && <Calendar className="w-5 h-5"/>}
                    {tab==='food' && <Utensils className="w-5 h-5"/>}
                    {tab==='prep' && <ClipboardList className="w-5 h-5"/>}
                    {tab==='coupons' && <Ticket className="w-5 h-5"/>}
                    {tab==='translate' && <Languages className="w-5 h-5"/>}
                    <span className="text-[10px]">{tab==='planner'?'è¡Œç¨‹':tab==='food'?'ç¾é£Ÿ':tab==='prep'?'æº–å‚™':tab==='coupons'?'å„ªæƒ ':'ç¿»è­¯'}</span>
                 </button>
             ))}
          </nav>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>